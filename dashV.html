<!DOCTYPE html>
<html>

<head>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dash</title>
 
    <script src="https://kit.fontawesome.com/af9ae991ce.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <!-- CSS -->
    <link href="dashboard.css" rel="stylesheet" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>

<body class="">
    <nav class="navbar navbar-vertical fixed-left navbar-expand-md navbar-light bg-white" id="sidenav-main">
        <div class="container-fluid">
            </button>
            <!-- Brand -->
            <br>
            <br>
            <br>
            <!-- <a class="navbar-brand pt-0" href="../index.html">
                <img src="../assets/img/brand/blue.png" class="navbar-brand-img" alt="...">
            </a> -->
            <!-- User -->
            <ul class="nav align-items-center d-md-none">
                <li class="nav-item dropdown">
                    <a class="nav-link" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <div class="media align-items-center">
                            <i class="fas fa-user-cog"></i>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right">
                        <div class=" dropdown-header noti-title">
                            <h6 class="text-overflow m-0">Welcome!</h6>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="dashV" class="dropdown-item">
                            <i class="fas fa-list"></i>
                            <span>Requests</span>
                        </a>
                        <a href="out" class="dropdown-item">
                            <i class="fas fa-power-off"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </li>
            </ul>
            <!-- Collapse -->
            <div class="collapse navbar-collapse" id="sidenav-collapse-main">
                <!-- Collapse header -->
                <div class="navbar-collapse-header d-md-none">
                    <div class="row">
                        <div class="col-6 collapse-close">
                            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#sidenav-collapse-main" aria-controls="sidenav-main" aria-expanded="false" aria-label="Toggle sidenav" style="float: right;"> 
                <span></span>
                <span></span>
              </button>
                        </div>
                    </div>
                </div>
                <!-- Navigation -->
                <ul class="navbar-nav">
                    <li class="nav-item  active ">
                        <a class="nav-link " href="/to_cart">
                            <i class="fas fa-desktop"></i></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link  active ">
                            <i class="fas fa-list"></i></i> Requests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="out">
                            <i class="fas fa-power-off"></i></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="main-content">
        <!-- Navbar -->
        <nav class="navbar navbar-top navbar-expand-md navbar-dark" id="navbar-main">
            <div class="container-fluid">
                <!-- Brand -->
                <a class="h4 mb-0 text-white text-uppercase d-none d-lg-inline-block" href="#">Requests</a>
                <!-- User -->
                <ul class="navbar-nav align-items-center d-none d-md-flex">
                    <li class="nav-item dropdown">
                        <a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <div class="media align-items-center">
                                <span class="rounded-circle">
                                    <i class="fas fa-user-cog"></i>
                </span>
                                <div id=userName class="media-body ml-2 d-none d-lg-block">
                                    <span class="mb-0 text-sm  font-weight-bold"></span>
                                </div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right">
                            <div class=" dropdown-header noti-title">
                                <h6 class="text-overflow m-0">Welcome!</h6>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="out" class="dropdown-item">
                                <i class="fas fa-power-off"></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- End Navbar -->
        <!-- Header -->
        <div class="header pt-md-4">
        </div>

        <div class="container-fluid" style="padding-top: 2%;">
            <div class="header-body">
                <!-- Card stats -->
                <div class="row" id="root_div">
                </div>
            </div>
        </div>
    </div>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-database.js"></script>

    <script>
        function pendingCard(status, id, name, phone, price) {
            var display = "relative";
            var icon_bg = "bg-danger"
            var icon = "fa fa-ban f-right";
            switch (status) {
                case "pending":
                    icon = "fa fa-refresh f-right";
                    icon_bg = "bg-warning";
                    break;
                case "accepted":
                    icon = "fa fa-cart-plus f-right";
                    icon_bg = "bg-info";
                    break;
                case "processing":
                    icon_bg = "bg-yellow";
                    icon = "fa fa-rocket f-right";
                    break;
                case "done":
                    icon_bg = "bg-success";
                    icon = "fa fa-credit-card f-right";
                    break;
                default:
                    icon_bg = "bg-danger";
                    icon = "fa fa-ban f-right";
                    break;
            }

            var crd = '<div id="div_' + id + '" class="col-xl-3 col-lg-6" style="padding-top: 2%;">' +
                '<div class="card card-stats mb-4 mb-xl-0">' +
                '<div class="card-body">' +
                '<div class="row">' +
                '<div class="col">' +
                '<h5 id="label_stat_' + id + '" class="card-title text-uppercase text-muted mb-0">Status: ' + status + '</h5>' +
                '<span id="price_' + id + '" class="h2 font-weight-bold mb-0">' + price + '</span>' +
                '<div class="btn-wrapper text-left">' +
                '<br>' +
                '<td><button id="stat_but_acc' + id + '" type="button" style=" margin: 5px 5px 5px 5px;display:' + display + ';" class="btn btn-secondary btn-sm">accept</button>' +
                '<button id="stat_but_rej' + id + '" type="button" style=" margin: 5px 5px 5px 5px;display:' + display + ';" class="btn btn-secondary btn-sm">reject</button></td>' +
                '</div>' +
                '</div>' +
                '<div class="col-auto">' +
                '<div id="style_' + id + '"class="icon icon-shape ' + icon_bg + ' text-white rounded-circle shadow">' +
                '<i class="' + icon + '"></i>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<br>' +
                '<span class="text-muted mr-2">' + phone + '</span>' +
                '<p id="itemtb_' + id + '" class="mt-3 mb-0 text-muted text-sm">' +
                '<span class="text-nowrap"></span>' +
                '</p>' +
                '</div>' +
                '</div>'

            $('#root_div').append(crd);

            $('#stat_but_acc' + id).attr('onClick', 'accept("' + id + '","' + phone + '");');
            $('#stat_but_rej' + id).attr('onClick', 'reject("' + id + '","' + phone + '");');
        }

        function accept(key, from) {
            var status = document.getElementById("stat_but_acc" + key).innerHTML;
            if (status == "accept") status = "accepted";
            if (status == "process") status = "processing";
            firebase.database().ref('cart/' + key).child("from_to_status").set(from + "_" + t + "_" + status);
            firebase.database().ref('order/' + t).child(key).set(from + "_" + status);
        }

        function reject(key, from) {
            firebase.database().ref('order/' + t).child(key).remove();
        }
    </script>



    <script>
        //var t="9946784176";
        //qwertyuhnb238d7hdn938
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyAkGopYf5Rgen_GgBpJ_VwQAzNZ1LRx3sg",
            authDomain: "covid-19-help-desk.firebaseapp.com",
            databaseURL: "https://covid-19-help-desk.firebaseio.com",
            projectId: "covid-19-help-desk",
            storageBucket: "covid-19-help-desk.appspot.com",
            messagingSenderId: "259588761043",
            appId: "1:259588761043:web:b45b72ba9d8707bb6dfb26",
            measurementId: "G-KZ7SN1WW8F"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        var database = firebase.database();
        database.ref('order/' + t).on('value', function(snapshot) {
            //	var key = snapshot.key; // "ada"
            document.getElementById("root_div").innerHTML = "";
            snapshot.forEach(function(data) {
                var f = document.getElementById("div_" + data.key);

                var det = data.val().split('_');
                pendingCard(det[1], data.key, "...", det[0], "...");

                var pr = document.getElementById("price_" + data.key);
                var itemtb = document.getElementById("itemtb_" + data.key);
                firebase.database().ref('cart/' + data.key).on('value', function(snapshot) {
                    var key = snapshot.key;
                    var tot = 0;
                    var tbl = ""
                    snapshot.forEach(function(data) {
                        if (data.key == "from_to_status") {
                            var m = data.val().split("_");
                            var stat = document.getElementById("label_stat_" + key);
                            stat.innerHTML = "Status : " + m[2];
                            if (m[1] == t) {
                                if (m[2] == "accepted") {
                                    var b1 = document.getElementById("stat_but_acc" + key);
                                    $("#stat_but_rej" + key).remove();
                                    b1.innerHTML = "process";
                                } else if (m[2] == "processing") {
                                    $("#stat_but_acc" + key).remove();
                                    $("#stat_but_rej" + key).remove();
                                } else {
                                    $("#stat_but_acc" + key).remove();
                                    $("#stat_but_rej" + key).remove();
                                }
                            } else if (m[1] == "x") {} else {
                                $("#div_" + key).remove();
                                firebase.database().ref('order/' + t).child(key).remove();
                            }
                        } else {
                            var temp = data.val().split(" x ");

                            tot += parseInt(temp[0]) * parseFloat(temp[1].split("/")[0]);
                            tbl += '<p>' + data.key + ' - ' + data.val() + '</p>';
                        }

                        pr.innerHTML = " " + tot.toFixed(2) + " ";
                        itemtb.innerHTML = tbl
                    });
                });
            });
        });

        function writeCart(item, quantity) {
            firebase.database().ref(t + '/cart').child(item).set(quantity);
        }
    </script>
</body>

</html>
